<!DOCTYPE html>
<html>
<head>
    <title>Phone provider 2000 - wanna know your data?</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="/css/main.css">
    <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet">
</head>
<body>
<header>
    <div style="max-width:900px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:64px;">
        <div style="display:flex;align-items:center;gap:14px;">
            <img src="https://img.icons8.com/ios-filled/40/007bff/phone.png" alt="Logo" style="height:36px;">
            <span style="font-size:1.5em;font-weight:600;color:#222;letter-spacing:0.5px;">Phone Provider 2000</span>
        </div>
        <nav style="display:flex;gap:24px;">
            <a href="/web" style="color:#007bff;font-weight:500;text-decoration:none;font-size:1.08em;">Chat</a>
            <a href="/products" style="color:#007bff;font-weight:500;text-decoration:none;font-size:1.08em;">E-Shop</a>
            <a href="#" id="openTenantModal"
               style="color:#007bff;font-weight:500;text-decoration:none;font-size:1.08em;">Tenant</a>
        </nav>
    </div>
</header>
<main>
    <section class="search-container">
        <span style="font-size:1.3em;color:#007bff;margin-right:8px;">üîç</span>
        <input type="text" id="searchInput" placeholder="Enter your query..." style="flex:1;">
        <select id="searchType">
            <option value="hybrid">Hybrid</option>
            <option value="vector">Vector</option>
            <option value="keyword">Keyword</option>
        </select>
        <button id="searchButton">Ask</button>
    </section>
    <div class="loading" id="loading">Loading...</div>
    <section id="results" style="margin-top:32px;"></section>
</main>
<div id="tenantModal" class="modal">
    <div class="modal-content" style="border-radius:10px;border:1px solid #e5e7eb;box-shadow:none;">
        <span class="close">&times;</span>
        <p style="font-weight:600;font-size:1.08em;">Connect with tenants:</p>
        <select id="tenantInput"></select>
    </div>
</div>
<footer>
    &copy; 2025 Phone Provider 2000. All rights reserved.
</footer>
<script>
    async function fetchTenants() {
        const response = await fetch(`/tenants`)
        const tenants = await response.json();
        tenantSelect = document.getElementById('tenantInput');
        for (const i in tenants) {
            const tenant = tenants[i];
            let option = document.createElement('option');
            option.setAttribute('value', tenant);
            option.textContent = tenant
            tenantSelect.appendChild(option)
        }
        const currentTenant = tenants[0]
        document.getElementById('searchInput').setAttribute('placeholder', `Hi ${currentTenant}, can I help you with anything?`);
    }

    // Typewriter effect function
    async function typeWriter(element, text, speed = 50) {
        const words = text.split(' ');
        element.innerHTML = '';
        element.classList.add('typing');

        text = ""

        for (let i = 0; i < words.length; i++) {
            const word = words[i];
            text = text + word + " "
            element.innerHTML = marked.parse(text)

            // Add a small delay between words
            await new Promise(resolve => setTimeout(resolve, speed));
        }

        element.classList.remove('typing');
    }

    async function performSearch() {
        const query = document.getElementById('searchInput').value;
        const searchType = document.getElementById('searchType').value;
        if (!query.trim()) return;

        const loading = document.getElementById('loading');
        const results = document.getElementById('results');

        loading.style.display = 'block';
        results.innerHTML = '';

        try {
            const tenant = document.getElementById('tenantInput').value;
            const response = await fetch(`/query/${tenant}/${searchType}/${encodeURIComponent(query)}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            // Create the results display
            let html = '';
            extract_score = function (text) {
                extract_score_re = /Score: ([0-9]*)\//g;
                score = extract_score_re.exec(text)
                if (!score) return 0;
                return parseFloat(score[1])
            }
            if (data.objects) {
                data.objects.sort((a, b) => {
                    return extract_score(b.generated) - extract_score(a.generated)
                })
            }

            // Final Answer Card
            if (data.final_answer) {
                html += `
                            <div class="card">
                                <div class="card-title">Answer</div>
                                <div class="final-answer"></div>
                            </div>
                        `;
            }

            // Products Card
            if (data.objects && data.objects.length > 0) {
                html += `
                            <div class="card">
                                <div class="card-title">Sources</div>
                                ${data.objects.map(bill => `
                                    <div class="product-card">
                                      <pre>${JSON.stringify(bill, null, 2)}</pre>
                                    </div>
                                `).join('')}
                            </div>
                        `;
            }


            // Search Details Card
            if (data.searches && data.searches.length > 0) {
                html += `
                            <div class="card">
                                <div class="card-title">Search Details</div>
                                <div class="search-details">${JSON.stringify(data.searches, null, 2)}</div>
                            </div>
                        `;
            }

            // Sources Card
            if (data.sources && data.sources.length > 0) {
                html += `
                            <div class="card">
                                <div class="card-title">Sources</div>
                                <ul class="sources-list">
                                    ${data.sources.map(source => `
                                        <li class="source-item">
                                            Collection: ${source.collection}<br>
                                            Object ID: ${source.object_id}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        `;
            }

            // Aggregations Card
            if (data.aggregations && data.aggregations.length > 0) {
                html += `
                            <div class="card">
                                <div class="card-title">Aggregations</div>
                                <div class="search-details">
                                    ${JSON.stringify(data.aggregations, null, 2)}
                                </div>
                            </div>
                        `;
            }

            // Usage Info
            if (data.usage) {
                html += `
                            <div class="card">
                                <div class="card-title">Usage Information</div>
                                <div class="usage-info">
                                    Requests: ${data.usage.requests}<br>
                                    Total Tokens: ${data.usage.total_tokens}<br>
                                    Response Time: ${data.total_time.toFixed(2)}s
                                </div>
                            </div>
                        `;
            }

            results.innerHTML = html;

            // Start typewriter effect for final answer
            if (data.final_answer) {
                const finalAnswerElement = document.querySelector('.final-answer');
                await typeWriter(finalAnswerElement, data.final_answer);
            }

        } catch (error) {
            results.innerHTML = `<div class="error">Error: ${error.message}</div>`;
        } finally {
            loading.style.display = 'none';
        }
    }

    document.getElementById('searchButton').addEventListener('click', performSearch);

    document.getElementById('searchInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            performSearch();
        }
    });
    document.getElementById('tenantInput').addEventListener("change", async function () {
        const value = document.getElementById('tenantInput').value;
        document.getElementById('searchInput').setAttribute('placeholder', `Hi ${value}, can I help you with anything?`);
        const response = await fetch(`/select/tenant/${value}`);
    });

    // Get the modal
    var modal = document.getElementById("tenantModal");

    // Get the button that opens the modal
    var btn = document.getElementById("openTenantModal");

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks on the button, open the modal
    btn.onclick = function () {
        modal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.onclick = function () {
        modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }


    fetchTenants()
</script>
</body>
</html>
